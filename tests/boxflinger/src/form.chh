#!/usr/bin/chippy

load("libboxflinger.chh");

# Form state
var formData = [];
formData = append(formData, "John Doe");      # Name
formData = append(formData, 25);              # Age
formData = append(formData, 1);               # Gender index
formData = append(formData, []);              # Interests
formData = append(formData, 50);              # Satisfaction slider

var fieldCount = 5;
var currentField = 1;

func RenderForm()
{
	ClearScreen();

	# Title
	BFDrawFrame(2, 1, 76, 18, "User Information Form");
	BFDrawText(4, 2, "Use TAB/UP/DOWN to navigate, ENTER to edit, ESC to exit");

	# Name
	var nameLabel = "Name: ";
	var nameValue = formData[1];

	if currentField == 1
	{
		SetAttribute(COLORBLACK);
		SetAttribute(COLORBGWHITE);
	}

	BFDrawText(4, 4, nameLabel + nameValue);

	if currentField == 1
	{
		SetAttribute(COLORRESET);
		BFDrawText(50, 4, "<-- Press ENTER to edit");
	}

	# Age
	var ageLabel = "Age: ";
	var ageValue = str(int(formData[2]));

	if currentField == 2
	{
		SetAttribute(COLORBLACK);
		SetAttribute(COLORBGWHITE);
	}

	BFDrawText(4, 5, ageLabel + ageValue);

	if currentField == 2
	{
		SetAttribute(COLORRESET);
		BFDrawText(50, 5, "<-- Press ENTER to edit");
	}

	# Gender
	var genderLabel = "Gender: ";
	var genderOptions = ["Male", "Female", "Other"];
	var genderIndex = formData[3];
	var genderValue = genderOptions[genderIndex];

	if currentField == 3
	{
		SetAttribute(COLORBLACK);
		SetAttribute(COLORBGWHITE);
	}

	BFDrawText(4, 6, genderLabel + genderValue);

	if currentField == 3
	{
		SetAttribute(COLORRESET);
		BFDrawText(50, 6, "<-- Press ENTER to edit");
	}

	# Interests
	var interestsLabel = "Interests: ";
	var interests = ["Programming", "Music", "Sports", "Reading"];
	var checkedIndices = formData[4];
	var interestsList = "";

	for i = 1 to len(checkedIndices)
	{
		var idx = checkedIndices[i];
		var interest = interests[idx];

		if i > 1
		{
			interestsList = interestsList + ", ";
		}

		interestsList = interestsList + interest;
	}

	if len(interestsList) == 0
	{
		interestsList = "(none)";
	}

	if currentField == 4
	{
		SetAttribute(COLORBLACK);
		SetAttribute(COLORBGWHITE);
	}

	BFDrawText(4, 7, interestsLabel + interestsList);

	if currentField == 4
	{
		SetAttribute(COLORRESET);
		BFDrawText(50, 7, "<-- Press ENTER to edit");
	}

	# Satisfaction
	var satisfactionLabel = "Satisfaction: ";
	var satisfactionValue = str(int(formData[5])) + "%";

	if currentField == 5
	{
		SetAttribute(COLORBLACK);
		SetAttribute(COLORBGWHITE);
	}

	BFDrawText(4, 8, satisfactionLabel + satisfactionValue);

	if currentField == 5
	{
		SetAttribute(COLORRESET);
		BFDrawText(50, 8, "<-- Press ENTER to edit");
	}

	# Submit button
	if currentField == 6
	{
		BFDrawButton(4, 10, "Submit Form", true);
	}
	else
	{
		BFDrawButton(4, 10, "Submit Form", false);
	}

	# Instructions
	BFDrawText(4, 12, "Navigation:");
	BFDrawText(6, 13, "TAB / DOWN arrow - Next field");
	BFDrawText(6, 14, "UP arrow         - Previous field");
	BFDrawText(6, 15, "ENTER            - Edit current field");
	BFDrawText(6, 16, "ESC              - Exit form");

	CursorToXY(1, 19);
}

# Main loop
func TestForm()
{
	var running = true;

	HideCursor();
	ClearScreen();

	while running
	{
		RenderForm();

		var key = getch();

		if key == BFKEYESC
		{
			running = false;
		}
		elseif key == BFKEYTAB or key == BFKEYDOWN
		{
			# Move to next field
			currentField = currentField + 1;

			if currentField > fieldCount + 1
			{
				currentField = 1;
			}
		}
		elseif key == BFKEYUP
		{
			# Move to previous field
			currentField = currentField - 1;

			if currentField < 1
			{
				currentField = fieldCount + 1;
			}
		}
		elseif key == BFKEYENTER
		{
			# Edit current field
			if currentField == 1
			{
				# Name field
				var result = BFTextInput(4, 20, 40, "Enter name: ", formData[1]);

				if not iserr(result)
				{
					formData = formData[1] = result;
				}

				BFClearRegion(4, 20, 60, 1);
			}
			elseif currentField == 2
			{
				# Age field
				var result = BFNumberInput(4, 20, "Enter age", 0, 120, formData[2]);

				if not iserr(result)
				{
					formData = formData[2] = result;
				}

				BFClearRegion(4, 20, 60, 2);
			}
			elseif currentField == 3
			{
				# Gender field
				var genderOptions = ["Male", "Female", "Other"];
				var result = BFRadioGroup(4, 20, genderOptions, formData[3]);

				if not iserr(result)
				{
					formData = formData[3] = result;
				}

				BFClearRegion(4, 20, 40, len(genderOptions));
			}
			elseif currentField == 4
			{
				# Interests field
				var interests = ["Programming", "Music", "Sports", "Reading"];
				var result = BFCheckboxList(4, 20, 40, len(interests), interests, formData[4]);

				if not iserr(result)
				{
					formData = formData[4] = result;
				}

				BFClearRegion(4, 20, 40, len(interests));
			}
			elseif currentField == 5
			{
				# Satisfaction field
				var result = BFSlider(4, 20, 30, "Satisfaction", formData[5], 0, 100, 5);

				if not iserr(result)
				{
					formData = formData[5] = result;
				}

				BFClearRegion(4, 20, 60, 2);
			}
			elseif currentField == 6
			{
				# Submit button
				var confirm = BFConfirm(4, 20, "Submit this form?", true);

				if not iserr(confirm) and confirm == true
				{
					ClearScreen();
					ShowCursor();

					Println("=== Form Submitted ===");
					Println("");
					Println("Name: " + formData[1]);
					Println("Age: " + str(int(formData[2])));

					var genderOptions = ["Male", "Female", "Other"];
					Println("Gender: " + genderOptions[formData[3]]);

					var interests = ["Programming", "Music", "Sports", "Reading"];
					var checkedIndices = formData[4];
					Print("Interests: ");

					if len(checkedIndices) == 0
					{
						Println("(none)");
					}
					else
					{
						for i = 1 to len(checkedIndices)
						{
							if i > 1
							{
								Print(", ");
							}

							Print(interests[checkedIndices[i]]);
						}

						Println("");
					}

					Println("Satisfaction: " + str(int(formData[5])) + "%");
					Println("");
					Println("Press any key to return to menu...");

					getch();

					running = false;
				}
				elseif not iserr(confirm)
				{
					# User chose No, just clear the dialog
					BFClearRegion(4, 20, 60, 3);
				}
				else
				{
					# User cancelled with ESC, just clear the dialog
					BFClearRegion(4, 20, 60, 3);
				}
			}
		}
	}

	ShowCursor();
	ClearScreen();
}

